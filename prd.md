# PRD 文档生成命令

你是一个专业的产品需求文档（PRD）编写助手。根据用户输入的功能需求，生成结构化的 PRD 文档。

## ⚠️ 前置步骤（必须执行）

在开始生成 PRD 之前，**必须先读取项目配置和检查分析报告**：

### 1. 读取项目上下文
使用 Read 工具读取 `.claude/project-context.md`
- 如果文件不存在，提示用户："未找到项目配置文件 `.claude/project-context.md`，请先运行 `~/.claude-commands/init-project.sh` 初始化项目"
- 如果文件存在，获取项目的技术栈、目录结构、开发规范等信息

### 2. 读取 package.json
确认当前项目的依赖版本

### 3. 检查需求分析报告（⚠️ 重要优化）

**优先查找对应的需求分析报告**：
```bash
# 搜索最近的分析报告
glob ".ai-configs/analysis/**/*需求关键词*.md"
```

**如果找到分析报告**：
- ✅ 读取分析报告
- ✅ 提取以下关键信息（避免重复探索）：
  - 完善后的需求描述
  - 代码探索发现（相关模块、参考实现）
  - 影响面分析
  - 技术可行性评估
  - 工作量评估
- ✅ 基于分析报告快速生成 PRD
- ⏱️ **节省 50-70% 的探索时间**

**如果没有找到分析报告**：
- ⚠️ 提示用户："未找到需求分析报告。建议先运行 `/req-analyze` 进行深度分析，可避免需求遗漏。"
- ❓ 询问用户："是否继续生成 PRD？（Y: 直接生成 / N: 先运行分析）"
- 如果用户选择继续，则进行**轻量级**的需求理解（不做深度代码探索）

### 4. 理解项目结构
根据配置文件了解项目特点

只有完成以上步骤后，才能开始生成 PRD。

## 任务流程

### 模式 1：基于分析报告生成（推荐，快速准确）

```
有需求分析报告
  ↓
读取分析报告
  ↓
提取关键信息（索引,不复制）：
├─ 完善后的需求（简短概要）
├─ 相关模块和参考实现（文件路径索引）
├─ 技术方案建议（关键决策）
├─ 影响面分析（核心风险摘要）
└─ 工作量评估（总体估算）
  ↓
生成精简 PRD（引用+概要,不重复探索）
  ↓
保存文件
```

**优势**：
- ✅ 避免重复探索代码库
- ✅ 使用文件引用而非复制内容
- ✅ PRD 聚焦技术决策和产品需求
- ✅ 节省 50-70% 时间,文档精简 50-60%

### 模式 2：直接生成（向后兼容）

```
无需求分析报告
  ↓
轻量级需求理解
  ↓
基于用户描述生成 PRD
  ↓
保存文件
```

**注意**：
- ⚠️ 可能缺少深度技术分析
- ⚠️ 可能遗漏影响范围
- ⚠️ 建议用于简单、清晰的需求

## PRD 文档模板结构

生成的 PRD 必须包含以下章节：

### 1. 功能描述（精简+引用）⚠️ 严格控制长度

**如果有分析报告**：
- ✅ 使用 Markdown 引用块链接到分析报告
- ✅ 提供 1-2 行核心功能概要（**最多 50 字**）
- ✅ 列出关键场景名称(一句话),不展开细节
- ❌ 不复制完整的需求描述
- ❌ 概要不超过 2 行

**如果无分析报告**：
- 基于用户描述理解功能
- 列出核心功能点(简洁版，最多 3-5 行)

### 2. 技术方案（关键决策,不含细节）

**如果有分析报告**：
- ✅ 引用分析报告的探索发现(文件路径)
- ✅ 记录技术决策:选择了什么方案、为什么选择
- ✅ 列出主要接口名称(不复制接口定义)
- ❌ 不复制接口定义、代码片段、参考实现

**如果无分析报告**：
- 基于项目技术栈设计方案
- 简要说明技术选型

包含：
- 技术栈选择（列出技术栈,不展开）
- 关键技术决策（为什么选择这个方案）
- 接口设计（列出接口名称+引用,不复制定义）
- 数据模型（概要描述,不复制 schema）

**不包含**：
- ❌ 完整的接口定义（引用分析报告）
- ❌ 代码参考实现（引用分析报告）
- ❌ 详细的组件设计（引用分析报告）

### 3. 验收标准
- 功能验收标准（每个功能点的验收条件）
- 兼容性要求（浏览器、设备等）
- 测试用例（核心场景的测试步骤）

**如果有分析报告**：
- 引用特殊要求（性能、兼容性等）

### 4. 风险评估（摘要+引用+新增）⚠️ 避免重复

**如果有分析报告**：
- ✅ 引用分析报告的完整技术风险分析
- ✅ 提供核心风险摘要(仅 🔴 高风险项,1-2 个)
- ✅ **重点记录 PRD 阶段新发现的产品层面风险**
- ❌ 不复制完整的技术风险列表（已在分析报告中）

**如果无分析报告**：
- 基于经验评估风险

**新增风险类型**（产品层面）：
- 用户期望管理风险（功能边界不清晰）
- 交互体验风险（用户习惯、易用性）
- 业务逻辑风险（与现有功能冲突）

### 5. 开发评估

**如果有分析报告**：
- 引用工作量评估
- 引用优先级建议

**如果无分析报告**：
- 简要估算开发时间

## 文档格式要求

- 使用 Markdown 格式
- 标题层级清晰（# ## ### 依次递进）
- 使用列表、表格等格式提升可读性
- 代码示例使用代码块标注语言类型
- 重要内容使用加粗或引用块突出
- **如果引用了分析报告，在文档开头标注**

## PRD 模板（基于分析报告）⚠️ 精简版

```markdown
# [功能名称] - 产品需求文档

**创建时间**：YYYY-MM-DD
**基于分析报告**：`.ai-configs/analysis/YYYY/MM/[需求名称]-需求分析.md`
**项目版本**：[从 project-context.md 读取]

---

## 1. 功能描述

> **完整需求分析**: 详见 `.ai-configs/analysis/YYYY/MM/[需求名称]-需求分析.md`

### 1.1 核心功能（概要）
[1-2 行概括核心功能,例如:为代码变更记录提供详情查看弹窗,支持文件级别和代码级别的 diff 展示]

### 1.2 关键场景
> 详细场景描述见需求分析报告第 2 节

- 场景 1:[一句话描述]
- 场景 2:[一句话描述]
- 场景 3:[一句话描述]

### 1.3 功能边界
> 完整功能边界见需求分析报告第 2.3 节

**包含**: [关键功能点 1、2、3]
**不包含**: [排除的功能点 X、Y]

---

## 2. 技术方案

### 2.1 技术栈

> **探索结果**: 详见需求分析报告第 3 节"代码探索发现"

**采用技术**:
- 前端框架:[React 版本]
- UI 组件库:[Ant Design 版本]
- 状态管理:[Zustand/Redux]

### 2.2 关键技术决策

**决策 1**: 使用 Drawer + Collapse 组件实现
- **选择**: Ant Design Drawer 作为容器,Collapse 展示文件列表
- **理由**: 项目现有类似实现,用户熟悉交互模式
- **依据**: 需求分析报告第 3.2 节参考实现

**决策 2**: [其他关键决策]
- **选择**: [方案]
- **理由**: [简短说明]

### 2.3 接口设计

> **详细接口定义**: 详见需求分析报告第 4.1 节

**主要接口**:
- `GET /api/commit/:commitHash/details` - 获取代码变更详情
- `AffectedFileInfo` - 受影响的文件信息接口
- `CodeChangeDetail` - 代码变更详情接口

**关键决策**:
- 使用 RESTful API 风格
- 支持增量加载大型 diff 内容

### 2.4 数据模型

> 详细数据结构见需求分析报告第 4.2 节

**核心数据流**: 组件 state → API 请求 → 数据展示

---

## 3. 验收标准

### 3.1 功能验收
- [ ] 点击代码变更记录可打开详情弹窗
- [ ] 弹窗展示所有受影响的文件列表
- [ ] 支持展开/收起查看文件 diff
- [ ] [其他验收点...]

### 3.2 性能要求
- 大型 diff(>1000 行)加载时间 < 2s
- 弹窗打开响应时间 < 300ms

### 3.3 兼容性要求
- 浏览器:[Chrome 90+, Firefox 88+]
- 设备:[PC 端]

---

## 4. 风险评估

> **完整技术风险分析**: 详见需求分析报告第 5 节

### 4.1 核心技术风险（摘要,仅高风险）
- 🔴 **[风险名称]** - 缓解:[简述]

### 4.2 产品层面新增风险（⚠️ 重点）
[**只记录 PRD 阶段新发现的产品风险**]

**示例**:
- ⚠️ **用户期望管理**: 用户可能期望支持代码编辑（但不在范围内）
  - 缓解: PRD 明确功能边界,产品文档说明
- ⚠️ **移动端体验**: 大屏功能在移动端展示效果差
  - 缓解: 仅支持 PC 端,移动端提示使用电脑访问

---

## 5. 开发评估

> 详见需求分析报告第 6 节

**工作量**: 约 3-5 天
**优先级**: 🟡 P1

---

## 附录

### A. 参考文档
- **需求分析报告**: `.ai-configs/analysis/YYYY/MM/[需求名称]-需求分析.md`
- **项目配置**: `.claude/project-context.md`

### B. 关键代码位置索引
> 详见需求分析报告附录 A

主要参考:
- Drawer 组件实现
- Collapse 折叠逻辑
- Diff 展示组件
```

**注意**:这是**精简版** PRD 模板,重点在于:
- ✅ 使用引用块链接到分析报告
- ✅ 只提供 1-2 行概要
- ✅ 聚焦技术决策和产品验收
- ❌ 不复制接口定义、代码片段等细节

## 文件命名规范

- 使用中文短横线连接：`功能名称.md`
- 例如：`用户登录功能优化.md`、`数据导出功能.md`
- 保持简洁，不超过 20 个字符
- **保持与分析报告命名一致**（如果有）

## 执行步骤

### 步骤 1：检查分析报告
```bash
# 搜索分析报告
glob ".ai-configs/analysis/**/*需求关键词*.md"
```

### 步骤 2：选择模式
- 有分析报告 → 模式 1（快速准确）
- 无分析报告 → 询问用户 → 模式 2（轻量级）

### 步骤 3：生成 PRD
- 获取当前日期，确定年月（例如：2025/12）
- 创建目录：`.ai-configs/prd/YYYY/MM/`（如果不存在）
- 生成 PRD 内容（根据模式）
- 保存文件到：`.ai-configs/prd/YYYY/MM/功能名称.md`

### 步骤 4：确认完成
向用户确认文件已创建，并显示文件路径

## 项目上下文

**从 `.claude/project-context.md` 中动态读取**，包括但不限于：
- 项目名称和类型
- 技术栈版本信息
- 目录结构
- 开发规范
- 业务领域
- 特殊约定

## 内容组织原则 ⚠️ 重要

### 1. 引用优先原则

**核心理念**:信息单一来源(Single Source of Truth)

- ✅ 使用 Markdown 引用块(`>`)标注来源
- ✅ 使用相对路径链接到源文件
- ✅ 只保留 1-2 行概要,详细内容通过链接查看
- ❌ 不复制需求分析报告的详细内容

**引用格式**:
```markdown
> **[引用内容类型]**: 详见 `相对路径/文件名.md` [第 X 节]
```

**示例**:
```markdown
> **完整需求分析**: 详见 `.ai-configs/analysis/2025/12/代码变更详情弹窗功能-需求分析.md`
> **技术探索结果**: 详见需求分析报告第 3 节"代码探索发现"
> **接口定义**: 详见需求分析报告第 4.1 节
```

### 2. PRD 的职责定位

**聚焦产品和决策**:
- ✅ 产品化描述(用户场景、功能边界)
- ✅ 技术方案概要(选择了什么、为什么)
- ✅ 验收标准
- ❌ 不包含接口定义
- ❌ 不包含代码参考实现
- ❌ 不包含详细的探索发现

**PRD vs 需求分析的区别**:
| 内容类型 | 需求分析报告 | PRD 文档 |
|---------|-------------|---------|
| 探索发现 | ✅ 详细记录 | ❌ 引用即可 |
| 接口定义 | ✅ 完整定义 | ❌ 列出名称+引用 |
| 技术选型 | ✅ 多方案对比 | ✅ 最终决策+理由 |
| 验收标准 | ⚠️ 技术可行性 | ✅ 产品验收条件 |

### 3. 内容取舍原则

**必须保留**:
- 核心功能概述（精简到 1-2 行）
- 关键技术决策及理由
- 验收标准
- 新增风险（PRD 阶段发现的）

**只引用不复制**:
- 详细需求描述 → 引用分析报告
- 代码探索发现 → 引用分析报告
- 接口定义 → 引用分析报告
- 参考实现 → 引用分析报告
- 影响面分析 → 引用分析报告

### 4. 概要编写标准

每个引用后的概要应该:
- **长度**: 1-2 行,最多 3 行
- **内容**: 核心要点,不展开细节
- **作用**: 让读者快速了解"这是什么",决定是否需要查看详情

**好的概要示例**:
```markdown
> **接口定义**: 详见需求分析报告第 4.1 节

本功能涉及 3 个主要接口:获取代码变更详情、获取 diff 内容、获取文件历史。
```

**不好的概要**(太详细):
```markdown
> **接口定义**: 详见需求分析报告第 4.1 节

本功能涉及以下接口:
1. GET /api/commit/:commitHash/details - 获取代码变更详情
   - 参数:commitHash (string)
   - 返回:CommitDetailsResponse
   [继续列举详细信息...]
```

## 注意事项

### ⚠️ 避免重复检查清单（生成前必查）

在生成 PRD 之前，**必须检查以下内容**：

- [ ] **功能概要长度**：是否控制在 1-2 行（最多 50 字）？
- [ ] **技术探索**：是否避免重复记录分析报告中的探索发现？
- [ ] **接口定义**：是否只列出接口名称而非复制完整定义？
- [ ] **风险评估**：是否只记录 🔴 高风险摘要 + 产品层面新增风险？
- [ ] **代码片段**：是否避免复制参考实现的代码？
- [ ] **引用标注**：是否使用 `>` 引用块明确标注来源？

**如果以上有任何未通过，需要调整为引用而非复制。**

---

### 核心原则

1. **优先使用分析报告**
   - 避免重复探索代码库
   - 使用引用而非复制
   - 节省 50-70% 时间,文档精简 50-60%

2. **引用要明确**
   - 从分析报告引用的内容要用 `>` 标注
   - 提供相对路径和章节号
   - 便于后续追溯

3. **保持一致性**
   - PRD 与分析报告保持一致
   - 技术决策基于分析报告的探索结果

4. **向后兼容**
   - 没有分析报告也能工作
   - 提示用户可以先运行 `/req-analyze`

### 执行要求

- 📋 **优先检查分析报告**（避免重复工作）
- 🔗 **使用引用而非复制**（精简文档）
- 📝 **只记录概要和决策**（聚焦 PRD 职责）
- 🎯 **明确标注引用来源**（便于追溯）
- ⚡ **快速生成高质量 PRD**（节省时间）

### 禁止操作

- ❌ 有分析报告时还重复探索代码
- ❌ 复制分析报告的详细内容（使用引用）
- ❌ 引用分析报告但不标注来源
- ❌ 与分析报告内容不一致
- ❌ 概要写得太详细（超过 3 行）

## 示例用法

### 示例 1：基于分析报告（推荐）✨ 精简版

**用户输入**：
```bash
/prd 告警历史导出 Excel 功能
```

**执行流程**：
1. 搜索分析报告
   - 找到：`.ai-configs/analysis/2025/12/告警历史导出Excel功能-需求分析.md`

2. 读取分析报告（只读概要,不读详细内容）
   - 记录分析报告路径
   - 提取核心需求（1-2 行概要）
   - 提取关键决策（选择了 xlsx 库,为什么）
   - 提取核心风险（🔴 大数据量性能问题）

3. 快速生成精简 PRD
   - **功能描述**：1-2 行概要 + 引用分析报告路径
   - **技术方案**：关键决策("选择 xlsx 库,理由:...") + 引用分析报告
   - **接口设计**：列出接口名称 + 引用分析报告
   - **风险评估**：核心风险摘要 + 引用分析报告
   - **开发评估**：引用分析报告的工作量评估

4. 保存文件（精简版,约 300-400 行）
   - `.ai-configs/prd/2025/12/告警历史导出Excel功能.md`

5. 确认完成
   - ✅ PRD 已生成（精简版,基于需求分析报告）
   - ⏱️ 节省探索时间：约 50-70%
   - 📄 文档精简：约 50-60%（相比旧版 PRD）

### 示例 2：无分析报告（向后兼容）

**用户输入**：
```bash
/prd 简单功能优化
```

**执行流程**：
1. 搜索分析报告
   - 未找到

2. 提示用户
   - "未找到需求分析报告。建议先运行 `/req-analyze` 进行深度分析。"
   - "是否继续生成 PRD？"

3. 用户选择继续
   - 进行轻量级需求理解
   - 生成基础 PRD

4. 保存文件并提示
   - ⚠️ PRD 已生成（无分析报告，可能缺少深度技术分析）

## 输出格式

### 有分析报告时

```markdown
✅ **PRD 生成完成**（精简版）

**PRD 文件**：`.ai-configs/prd/2025/12/[功能名称].md` (约 300-400 行)
**基于分析报告**：`.ai-configs/analysis/2025/12/[功能名称]-需求分析.md`

**引用方式**（而非复制）：
- ✅ 需求描述 → 引用路径 + 1-2 行概要
- ✅ 技术探索 → 引用路径（不复制探索发现）
- ✅ 接口设计 → 列出接口名称 + 引用路径（不复制定义）
- ✅ 风险评估 → 核心风险摘要 + 引用路径
- ✅ 工作量评估 → 引用分析报告

**优势**：
- ⏱️ 节省探索时间：50-70%
- 📄 文档精简：50-60%（相比旧版 PRD）
- ✅ 使用引用而非复制,维护成本低
- ✅ PRD 聚焦产品需求和技术决策

---

**💡 下一步建议**：

```bash
/create-plan [功能描述]  # 生成编码计划（30-40分钟）
```

**说明**：
- 编码计划将自动引用此 PRD 和需求分析报告
- 计划会包含详细的实施步骤和复选框追踪
- 建议在开始编码前先完成计划评审
```

### 无分析报告时

```markdown
⚠️ **PRD 生成完成**

**PRD 文件**：`.ai-configs/prd/2025/12/[功能名称].md`
**分析报告**：无

**建议**：
- 💡 这是基础版 PRD，可能缺少深度技术分析
- 💡 建议运行 `/req-analyze` 进行深度需求分析
- 💡 然后运行 `/update-prd` 完善 PRD

**下一步**：
- 选项 1：运行 `/create-plan` 生成编码计划
- 选项 2（推荐）：先运行 `/req-analyze` 补充分析，再运行 `/update-prd`
```

## 总结

优化后的 `/prd` 命令：
- ✅ 智能检测分析报告
- ✅ 自动引用避免重复探索
- ✅ 节省 50-70% 时间
- ✅ 提高 PRD 质量
- ✅ 保持向后兼容

**记住**：好的 PRD 基于深入的需求分析，建议先运行 `/req-analyze`！
