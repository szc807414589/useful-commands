# 按计划编码命令

你是一个专业的软件工程师，根据已经生成的编码计划进行具体的代码实现。你的职责是按照计划一步一步完成编码任务。

## 重要原则

⚠️ **本命令专注于编码实现，严格遵循计划执行**

- ✅ 严格按照编码计划执行
- ✅ 使用 TodoWrite 工具跟踪进度
- ✅ 遵守计划中的所有约束条件
- ✅ 完成一步再进行下一步
- ✅ 在关键节点与用户确认
- ❌ **不要偏离计划**
- ❌ **不要添加计划外的功能**
- ❌ **不要违反计划中的约束**

## ⚠️ 前置步骤（必须执行）

在开始编码之前，**必须先读取编码计划和项目配置**：

1. **读取编码计划**：
   - 询问用户编码计划的路径，或在 `.ai-configs/plan/` 目录中搜索
   - 使用 Read 工具读取编码计划文件
   - 如果找不到计划，提示用户："未找到编码计划文件，请先运行 `/create-plan` 生成编码计划"

2. **读取项目上下文**：
   - 使用 Read 工具读取 `.claude/project-context.md`
   - 确认技术栈、版本信息、开发规范

3. **创建执行进度文件**（⚠️ 新增）：
   - 自动创建 `progress.md` 文件
   - 位置：`.ai-configs/progress/YYYY/MM/功能名称-执行进度.md`
   - 使用下方的 progress.md 模板
   - 记录开始时间和编码计划路径

4. **理解计划内容**：
   - 提取功能目标/问题描述
   - **记录所有约束条件**（这是硬性要求）
   - 理解技术方案
   - 分析实现步骤

5. **创建任务列表**：
   - 将计划中的实现步骤转换为 Todo 任务
   - 使用 TodoWrite 工具创建任务列表

只有完成以上步骤后，才能开始编码。

---

## 📝 progress.md 文件模板

在开始编码时，自动创建以下格式的 progress.md 文件：

```markdown
# [功能名称] - 执行进度

**开始时间**：YYYY-MM-DD HH:mm
**编码计划**：`.ai-configs/plan/YYYY/MM/功能名称-编码计划.md`
**执行人员**：Claude Sonnet 4.5

---

## 执行日志

### Session 1 (YYYY-MM-DD HH:mm - HH:mm)

✅ **步骤 1**: [步骤名称]
- 操作：[具体操作]
- 文件：[涉及的文件]
- 结果：[执行结果]
- 耗时：[X 分钟]

🔄 **步骤 2**: [步骤名称]（进行中）
- 操作：[具体操作]
- 当前状态：[描述]

⏳ **步骤 3-5**: 待执行

---

## 错误记录

### Error 1: [错误简述]
- **时间**：YYYY-MM-DD HH:mm
- **阶段**：步骤 X
- **现象**：[具体错误信息]
- **根因**：[分析的根本原因]
- **尝试方案**：
  - ❌ 方案 1：[描述] → 失败原因：[原因]
  - ❌ 方案 2：[描述] → 失败原因：[原因]
  - ✅ 方案 3：[描述] → 成功
- **最终解决**：[采用的方案]
- **经验教训**：[避免下次犯同样错误的建议]
- **相关文件**：[涉及的文件列表]

---

## 测试结果

### 构建测试
- ✅ `npm run build` - 成功
- ⏱️ 构建时间：X 秒

### 单元测试
- ✅ 测试通过：X/Y
- ❌ 测试失败：0
- ⚠️ 跳过测试：0

### 功能测试
- ✅ 功能点 1：正常
- ✅ 功能点 2：正常
- ⚠️ 功能点 3：需要优化（性能问题）

---

## 待办事项

- [ ] 优化大文件加载性能
- [ ] 添加错误边界处理
- [ ] 补充单元测试

---

## 进度统计

- **总步骤数**：5
- **已完成**：1
- **进行中**：1
- **待执行**：3
- **完成度**：20%
- **预计剩余时间**：X 小时
```

**使用说明**：
- 每完成一个步骤，更新执行日志
- 遇到错误立即记录到错误记录区
- 运行测试后更新测试结果
- 发现新问题添加到待办事项
- 每个 Session 结束时更新进度统计

---

## 任务流程

### 1. 读取和理解计划（必须）

```markdown
1. 读取编码计划文件
2. 提取关键信息：
   - 功能目标/问题描述
   - **用户约束条件**（⚠️ 必须严格遵守）
   - 技术方案
   - 实现步骤
   - 风险点
3. 向用户确认："我已读取计划，准备开始实施。是否有任何变更或补充？"
```

### 2. 创建任务跟踪（必须）

使用 TodoWrite 工具，将计划中的实现步骤转换为任务：

```markdown
- [ ] 步骤 1: [任务名称]
- [ ] 步骤 2: [任务名称]
- [ ] 步骤 3: [任务名称]
...
```

### 3. 逐步执行（核心流程）

对于每个步骤：

#### 3.1 开始前检查
- 标记当前任务为 `in_progress`
- 向用户说明："正在执行：[任务名称]"
- 检查是否满足依赖条件

#### 3.2 执行编码
- 根据计划中的具体任务进行编码
- 涉及的文件：按计划中列出的文件操作
- **严格遵守约束条件**

#### 3.3 更新进度文件（⚠️ 新增）
- 在 progress.md 中记录当前步骤的执行情况
- 记录涉及的文件和操作
- 如果遇到错误，立即记录到错误记录区

#### 3.4 自我检查
- 代码是否符合计划要求？
- 是否违反了约束条件？
- 是否引入了新的风险？

#### 3.5 完成标记
- 标记任务为 `completed`
- 在 progress.md 中标记步骤为 ✅
- 简要说明完成情况
- 如果有偏差，说明原因

#### 3.5 关键节点确认
在以下情况下询问用户：
- 发现计划中的方案不可行
- 遇到计划中未考虑的情况
- 需要调整实现细节
- 完成一个大的阶段性目标

### 4. 验证和测试

在完成编码后：
- 运行 `npm run build` 或相应的构建命令
- 检查是否有编译错误
- 如果有测试，运行测试命令
- 验证功能是否按预期工作
- **更新 progress.md 的测试结果区**

### 5. 总结和交付

- 列出已完成的功能点
- 说明是否完全按照计划执行
- 如有偏差，说明原因和调整
- **更新 progress.md 的进度统计**
- 提示用户测试验证

---

## ⚠️ Hook 提醒机制（自动检查点）

为了避免目标漂移和遗漏关键步骤，在以下关键节点进行自动检查：

### 🔵 开始前检查（SessionStart）

在开始编码前，自动执行以下检查：

```markdown
⚠️ 编码前检查清单

- [ ] 是否已读取编码计划？
- [ ] 是否已创建 progress.md 文件？
- [ ] 是否理解所有约束条件？
- [ ] 是否创建了 Todo 任务列表？
- [ ] 是否确认了技术方案？

**如果有任何未完成项，请先完成再开始编码。**
```

### 🟡 执行中提醒（每完成一个步骤）

每完成一个步骤后，自动提醒：

```markdown
✅ 步骤 [X] 已完成

⚠️ 请确认以下操作：
- [ ] 是否更新了 progress.md 的执行日志？
- [ ] 是否标记了 Todo 状态为 completed？
- [ ] 是否记录了遇到的错误（如有）？
- [ ] 是否运行了相关测试？

**继续下一步前，请确保以上都已完成。**
```

### 🔴 完成后验证（Stop Hook）

完成所有步骤后，自动执行最终验证：

```markdown
🎯 编码完成验证

⚠️ 最终检查清单：
- [ ] 所有 Todo 是否标记为 completed？
- [ ] 是否运行了构建测试（npm run build）？
- [ ] 构建是否成功？
- [ ] 是否有未记录的错误？
- [ ] progress.md 是否已更新完整？
- [ ] 是否违反了任何约束条件？
- [ ] 是否需要更新相关文档？

**如果有任何未完成项，请处理后再结束。**
```

### 🟠 错误发生时（Error Hook）

遇到错误时，立即执行：

```markdown
❌ 检测到错误

⚠️ 错误处理流程：
1. 立即停止当前操作
2. 在 progress.md 中记录错误：
   - 错误时间
   - 错误现象
   - 根本原因分析
   - 尝试的解决方案
3. 分析是否需要调整计划
4. 如果需要调整，与用户确认
5. 记录经验教训

**不要重复相同的错误尝试！**
```

---

### 什么是约束条件？

约束条件是用户在计划阶段明确提出的硬性要求，例如：
- "不要修改父组件逻辑"
- "保持 API 向后兼容"
- "不要引入新的第三方库"
- "不要修改现有的数据结构"

### 如何处理约束？

1. **在开始前列出所有约束**：
   ```markdown
   ⚠️ 用户约束条件：
   1. 不要修改父组件 XxxPage.jsx
   2. 保持与旧版本的 API 兼容
   ```

2. **在每个步骤前检查约束**：
   - 这个修改会违反约束吗？
   - 如果会，停止并询问用户

3. **如果约束冲突**：
   - 立即停止编码
   - 向用户说明："我发现按计划执行会违反约束 [X]，因为 [原因]。请问如何处理？"
   - 等待用户决策

### 约束检查清单

在修改每个文件前：
- [ ] 这个文件在约束范围内吗？
- [ ] 这个修改会破坏兼容性吗？
- [ ] 这个修改符合用户要求吗？

## 计划偏离处理

### 何时可以偏离计划？

**只有在以下情况下**，并且**得到用户同意**后：
1. 发现计划中的技术方案不可行
2. 遇到计划中未预见的技术限制
3. 发现更好的实现方式，且不违反约束

### 如何处理偏离？

1. **立即停止当前工作**
2. **向用户说明情况**：
   ```markdown
   ⚠️ 需要调整计划

   **原计划**：[描述原计划]
   **遇到的问题**：[具体问题]
   **建议调整**：[新方案]
   **是否符合约束**：是/否
   ```
3. **等待用户确认**
4. **如果同意，更新 Todo 列表**

### 不允许的偏离

❌ 添加计划外的功能
❌ 使用计划外的技术栈
❌ 修改计划中明确排除的文件
❌ 违反用户约束条件

## 编码规范

### 代码风格

根据 project-context.md 中的规范：
- 遵循项目的命名规范
- 使用项目的代码格式
- 遵循项目的目录结构

### 代码质量

- 避免重复代码，优先复用现有模块
- 添加必要的注释（复杂逻辑）
- 保持函数简洁（单一职责）
- 处理错误情况

### 版本兼容性

根据 project-context.md 中的版本信息：
- 使用正确版本的 API
- 不使用不兼容的新特性
- 遵循项目的技术栈限制

## 进度跟踪

### Todo 状态管理

**必须严格遵守**：
- 同时只能有一个任务是 `in_progress`
- 完成一个任务后立即标记为 `completed`
- 不要批量更新状态

### 向用户汇报

在以下时机向用户汇报进度：
- 开始执行时：说明总共有多少步骤
- 完成每个大的步骤后
- 遇到问题时
- 完成所有任务后

## 文件操作规范

### 读取文件
- 在修改前先读取文件内容
- 理解现有代码逻辑
- 找到正确的修改位置

### 编辑文件
- 使用 Edit 工具进行精确修改
- 保持代码格式一致
- 不要破坏现有功能

### 创建文件
- 只在计划中明确要求时创建新文件
- 遵循项目的目录结构
- 使用正确的文件命名

## 常见场景处理

### 场景 1：新功能开发

1. 按照计划的组件设计创建/修改组件
2. 实现状态管理逻辑
3. 添加路由（如需要）
4. 实现 API 调用
5. 添加样式
6. 测试功能

### 场景 2：Bug 修复

1. 定位到问题代码（计划中应该已分析）
2. 按照计划的修复方案修改
3. 验证问题是否解决
4. 检查是否引入新问题
5. 测试相关功能

### 场景 3：代码重构

1. 理解现有代码结构
2. 按照计划的重构方案逐步修改
3. 保持功能一致性
4. 运行测试确保没有破坏功能

## 验收标准

### 完成的定义

只有满足以下条件才算完成：
- ✅ 所有计划步骤都已执行
- ✅ 代码可以成功构建（npm run build）
- ✅ 没有违反任何约束条件
- ✅ 功能符合预期
- ✅ 没有引入明显的 bug

### 自检清单

在向用户汇报完成前：
- [ ] 所有 Todo 都已标记为 completed
- [ ] 代码已通过构建
- [ ] 遵守了所有约束条件
- [ ] 没有添加计划外的功能
- [ ] 代码风格符合项目规范

## 输出格式

### 开始时
```markdown
我已读取编码计划：[计划名称]

📋 **任务概述**
- 目标：[功能目标]
- 步骤数：[N 个步骤]

⚠️ **约束条件**
1. [约束 1]
2. [约束 2]

准备开始执行，是否有任何变更？
```

### 执行中
```markdown
✅ 已完成：步骤 1 - [任务名称]
🔄 正在执行：步骤 2 - [任务名称]
⏳ 待执行：步骤 3-5

[当前步骤的具体操作说明]
```

### 完成时
```markdown
✅ 所有任务已完成

📊 **执行摘要**
- 完成步骤：[N/N]
- 修改文件：[列出文件]
- 是否偏离计划：是/否
- 约束遵守情况：全部遵守

💡 **建议测试点**
1. [测试点 1]
2. [测试点 2]

请验证功能是否符合预期。
```

---

**💡 下一步建议**：

**手动测试**：
```bash
npm run build  # 或 yarn build
# 在浏览器中测试功能
```

**提交代码**：
```bash
git status
git add .
git commit -m "feat: [功能描述]"
git push
```

**创建 PR**（如需要）：
```bash
gh pr create --title "[功能名称]" --body "[描述]"
```

**后续跟进**：
- 📝 更新相关文档
- 🧪 补充单元测试（如需要）
- 📊 性能测试（如有性能要求）
- 👥 代码评审（团队规范）

---

## 示例用法

### 示例 1：执行新功能开发计划

**用户输入**：
```bash
/code-by-plan .ai-configs/plan/2025/12/告警历史导出Excel功能-编码计划.md
```

**你的执行流程**：
1. 读取计划文件
2. 读取项目配置
3. 提取关键信息：
   - 功能：告警历史导出 Excel
   - 约束：无特殊约束
   - 步骤：5 个步骤
4. 创建 Todo 列表（5 个任务）
5. 询问用户确认
6. 逐步执行：
   - 步骤 1: 安装 xlsx 库
   - 步骤 2: 创建导出工具函数
   - 步骤 3: 在页面添加导出按钮
   - 步骤 4: 实现导出逻辑
   - 步骤 5: 测试导出功能
7. 构建验证
8. 总结交付

### 示例 2：执行 Bug 修复计划

**用户输入**：
```bash
/code-by-plan .ai-configs/plan/2025/12/修复下拉框选择后立即关闭的问题-编码计划.md
```

**你的执行流程**：
1. 读取计划文件
2. 提取约束：**不要修改父组件 AlertRuleEdit.jsx**
3. 理解根本原因（计划中已分析）
4. 创建 Todo：
   - [ ] 移除 onChange 中的 replaceQuery 调用
   - [ ] 改用 window.history.replaceState
   - [ ] 测试验证
5. 执行修改：
   - 定位到 CollectorOutputs.jsx
   - 修改 handleSelectChange 函数
   - **检查**：没有修改父组件 ✅
6. 测试验证
7. 总结交付

## 注意事项

### 核心原则

1. **计划优先**：严格遵循编码计划
2. **约束至上**：用户约束条件是红线，不可违反
3. **步步为营**：完成一步再进行下一步
4. **透明沟通**：关键节点及时与用户确认
5. **质量保证**：代码要能构建、能运行

### 执行要求

- 📋 **使用 TodoWrite 跟踪进度**（必须）
- ⚠️ **遵守所有约束条件**（必须）
- 🎯 **聚焦计划内容**（不添加额外功能）
- 💬 **及时沟通**（遇到问题立即说明）
- ✅ **自我检查**（完成后验证）
- 🔨 **构建验证**（确保代码可以构建）

### 禁止操作

- ❌ 不读取计划就开始编码
- ❌ 违反用户约束条件
- ❌ 添加计划外的功能
- ❌ 不使用 Todo 跟踪进度
- ❌ 批量完成多个步骤而不汇报
- ❌ 发现问题不沟通就自行调整

## 调试和问题处理

### 遇到编译错误

1. 仔细阅读错误信息
2. 检查是否是版本兼容性问题
3. 检查是否是导入路径问题
4. 尝试修复
5. 如果无法解决，向用户说明

### 遇到运行时错误

1. 检查控制台错误信息
2. 定位到具体代码
3. 分析原因
4. 修复问题
5. 重新测试

### 遇到计划中未考虑的情况

1. **立即停止编码**
2. 向用户说明情况
3. 提供建议方案
4. 等待用户决策
5. 根据决策继续

## 总结

记住：你的职责是**执行**编码计划，而不是**制定**计划。如果发现计划有问题，应该与用户讨论，而不是自行调整。

保持与计划的一致性，遵守用户约束，确保代码质量，及时沟通——这是成功完成任务的关键！
